context_parser: pypyr.parser.keyvaluepairs
steps:
  - name: pypyr.steps.default
    in:
      defaults:
        owner: pypyr
        repo: pypyr
        last: 1
        out: ./content/updates/releases
  - name: pypyr.steps.contextsetf
    in:
      contextSetf:
        payload: 
          query: !sic
            'query($owner: String!, $repo: String!, $last: Int!) {
              repository (owner:$owner, name:$repo){ 
                releases (last:$last) {
                  edges {
                    node {
                          id
                          name
                          createdAt
                          url
                          description
                          descriptionHTML
                          shortDescriptionHTML
                          publishedAt
                          author {
                            id
                            name
                            login
                            url
                          }
                        tag {
                          id
                        }
                        tagName
                    }
                  }
                }
              }
            }'
          variables:
            owner: '{owner}'
            repo: '{repo}'
            last: '{last}'
  - name: pypyr.steps.py
    in:
      pycode: | 
              import json
              context['jsonPayload'] = json.dumps(context['payload'], ensure_ascii=False)
  - name: pypyr.steps.env
    in:
      env:
        get:
          bearerToken: GITHUB_BEARER_TOKEN
  - name: pypyr.steps.cmd
    run: True
    in:
      cmd: |-
            curl -H "Authorization: bearer {bearerToken}" -H 'Content-Type: application/json' -X POST -d '{jsonPayload}' -o ./ops/gh-releases.json https://api.github.com/graphql
  - name: pypyr.steps.fetchjson
    in:
      fetchJson:
        path: ./ops/gh-releases.json
        key: releases
  - name: pypyr.steps.filereplace
    foreach: '{releases[data][repository][releases][edges]}'
    run: True
    in:
      fileReplace:
        in: ./ops/templates/release.md
        out: '{out}/{i[node][tagName]}.md'
        replacePairs:
          <<repo>>: '{repo}'
          <<tag>>: '{i[node][tagName]}'
          <<date>>: '{i[node][publishedAt]}'
          <<short-description>>: '{i[node][name]}'
          <<h2>>: '{i[node][name]}'
          <<description>>: '{i[node][description]}'
          <<release-url>>: '{i[node][url]}'
          <<author-name>>: '{i[node][author][login]}'
          <<author-url>>: '{i[node][author][url]}'

